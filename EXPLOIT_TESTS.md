# Тесты Эксплойтов - Демонстрация Уязвимостей

## Обзор

Файл [`ExploitTests.java`](file:///home/yoptabyte/java-security/src/test/java/com/example/insecurebank/ExploitTests.java) содержит 7 автоматизированных тестов, демонстрирующих все критические уязвимости в небезопасном банковском приложении.

---

## Запуск Тестов

```bash
mvn test -Dtest=ExploitTests
```

**Ожидаемый результат**: Все 7 тестов должны **пройти успешно** , подтверждая наличие уязвимостей.

---

## 1. SQL Injection (`testSqlInjectionBypass`)

### Уязвимый Код
[InsecureUserDao.java:27-31](file:///home/yoptabyte/java-security/src/main/java/com/example/insecurebank/repository/InsecureUserDao.java#L27-L31)

```java
String sql = "SELECT ... WHERE username = '" + login + 
             "' AND password = '" + password + "'";
```

### Эксплойт
- **Username**: `admin`
- **Password**: `' OR '1'='1`

### Результат
SQL-запрос становится:
```sql
SELECT ... WHERE username = 'admin' AND password = '' OR '1'='1'
```

Условие `'1'='1'` всегда истинно → **обход аутентификации**.

### Демонстрация
Тест получает объект `User` без знания правильного пароля.

---

## 2. Race Condition (`testRaceConditionDoubleSpend`)

### Уязвимый Код
[TransferService.java:18-43](file:///home/yoptabyte/java-security/src/main/java/com/example/insecurebank/service/TransferService.java#L18-L43)

```java
public void transfer(Long fromAccountId, Long toAccountId, BigDecimal amount) {
    BankAccount fromAccount = bankAccountRepository.findById(fromAccountId).orElse(null);
    // ... read-modify-write без блокировок
    fromAccount.setBalance(fromAccount.getBalance().subtract(amount));
    bankAccountRepository.save(fromAccount);
}
```

### Эксплойт
10 параллельных потоков одновременно переводят по 20.00 со счёта с балансом 100.00.

### Результат
**Lost Updates (Потерянные обновления)**:
- **Ожидалось**: ACC1 = -100.00 (10 переводов × 20.00)
- **Фактически**: ACC1 = 80.00 (выполнился только 1 перевод)
- **Потеряно**: 9 переводов из 10

### Причина
Все потоки читают баланс 100.00, вычисляют 80.00, и перезаписывают друг друга.

---

## 3. XXE - XML External Entity (`testXxeVulnerability`)

### Уязвимый Код
[XmlImportService.java:14-17](file:///home/yoptabyte/java-security/src/main/java/com/example/insecurebank/service/XmlImportService.java#L14-L17)

```java
DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
// Нет защиты от внешних сущностей
DocumentBuilder builder = factory.newDocumentBuilder();
return builder.parse(file.getInputStream());
```

### Эксплойт
```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE foo [
  <!ELEMENT foo ANY >
  <!ENTITY xxe SYSTEM "file:///etc/hostname" >]>
<foo>&xxe;</foo>
```

### Результат
XML-парсер читает файл `/etc/hostname` и возвращает его содержимое в документе.


---

## 4. Stored XSS (`testStoredXss`)

### Уязвимый Код
[account.html:32](file:///home/yoptabyte/java-security/src/main/resources/templates/account.html#L32)

```html
<td th:utext="${tx.description}"></td>
```

### Эксплойт
Создать транзакцию с описанием: `<script>alert('XSS')</script>`

### Результат
XSS-payload сохраняется без санитизации. При рендеринге через `th:utext` скрипт выполнится в браузере.

### Демонстрация
Тест проверяет, что в базе данных сохранился сырой HTML с тегом `<script>`.

---

## 5. IDOR - Broken Access Control (`testIdorBrokenAccessControl`)

### Уязвимый Код
[AccountController.java](file:///home/yoptabyte/java-security/src/main/java/com/example/insecurebank/controller/AccountController.java), [TransferService.java](file:///home/yoptabyte/java-security/src/main/java/com/example/insecurebank/service/TransferService.java)

```java
@GetMapping("/accounts/{id}")
public String getAccount(@PathVariable Long id, Model model) {
    // Нет проверки владения!
    BankAccount account = bankAccountRepository.findById(id).orElse(null);
}
```

### Эксплойт
- Создать два счёта (USER_A и USER_B)
- Перевести деньги со счёта USER_B на USER_A без авторизации

### Результат
Любой пользователь может управлять чужими счетами, зная только ID.


---

## 6. Defensive Programming Violations (`testDefensiveProgrammingViolations`)

### Уязвимости
1. **Отсутствие Fail-Fast**: нет проверки предусловий
2. **Отсутствие Immutability**: объекты мутабельны

### Эксплойт 1: Negative Amount
```java
transferService.transfer(acc1, acc2, new BigDecimal("-50.00"));
```
Отрицательная сумма принимается без валидации.

### Эксплойт 2: Mutability
```java
account.setBalance(new BigDecimal("999999.00")); // Прямая мутация!
```
Объект можно изменить напрямую, нарушая инкапсуляцию.

---

## 7. Jackson Deserialization (`testJacksonPolymorphicDeserialization`)

### Уязвимый Код
[JacksonConfig.java:16-22](file:///home/yoptabyte/java-security/src/main/java/com/example/insecurebank/config/JacksonConfig.java#L16-L22)

```java
mapper.activateDefaultTyping(
    ..., ObjectMapper.DefaultTyping.EVERYTHING
);
```

### Эксплойт
Payload: `{"@class":"com.sun.rowset.JdbcRowSetImpl", ...}`

### Результат
Jackson может инстанцировать произвольные классы → **RCE** через gadget chains.

---

## Итоги

| Уязвимость | Тип | Критичность | Тест | Статус |
|------------|-----|-------------|------|--------|
| SQL Injection | Injection |  Критическая | `testSqlInjectionBypass` |
| Race Condition | Concurrency |  Критическая | `testRaceConditionDoubleSpend` |
| XXE | Injection |  Высокая | `testXxeVulnerability` | 
| Stored XSS | Injection |  Высокая | `testStoredXss` | 
| IDOR | Access Control |  Критическая | `testIdorBrokenAccessControl` | 
| Defensive Programming | Design |  Средняя | `testDefensiveProgrammingViolations` | 
| Deserialization | Injection |  Критическая | `testJacksonPolymorphicDeserialization` | 

